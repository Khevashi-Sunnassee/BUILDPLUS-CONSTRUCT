# LTE Performance Management System

## Overview
The LTE Performance Management System is a comprehensive platform designed to optimize panel production and delivery processes in the construction and manufacturing sectors. It streamlines operational efficiency in CAD and Revit time management, provides insights into production and financial performance, and manages the lifecycle of panel production and delivery. Key capabilities include daily log management, manager approval workflows, reporting, analytics, KPI dashboards, and a logistics system for load lists and delivery tracking, offering robust tools for decision-making and operational control.

## User Preferences
I prefer detailed explanations.
I want iterative development.
Ask before making major changes.
Do not make changes to the folder `node_modules/`.
Do not make changes to the file `package-lock.json`.

## System Architecture
The system utilizes a client-server architecture. The frontend is built with React + Vite, while the backend uses Express.js. PostgreSQL is the primary database, managed by Drizzle ORM. User authentication is handled via email/password with bcrypt and `express-session`, featuring Role-Based Access Control (RBAC) with granular per-user permissions.

**UI/UX Decisions:**
The frontend employs TanStack Query for data fetching, Wouter for routing, `shadcn/ui` for components, and Tailwind CSS for styling. It includes a KPI Dashboard with data visualization and PDF export, and interactive maps for factory management. Mobile pages follow strict design tokens and layout patterns, ensuring a consistent user experience with specific navigation and interaction guidelines.

**Technical Implementations & Features:**
- **Core Management:** Time & approval management, comprehensive reporting & analytics, and centralized admin provisioning for users, jobs, customers, and global settings.
- **Job & Panel Lifecycle:** Full CRUD for customer and job management, panel registration, production approval workflows, estimate import, and detailed panel field management. Panels are tracked through a 14-stage lifecycle with audit logging. Jobs have a 5-phase lifecycle (OPPORTUNITY → QUOTING → WON_AWAITING_CONTRACT → CONTRACTED, or LOST at any time) with 6 statuses (ACTIVE, ON_HOLD, PENDING_START, STARTED, COMPLETED, ARCHIVED). Phase progression is enforced sequentially, and each phase restricts which statuses and capabilities are available. Phase/status changes are audit-logged via `job_audit_logs` table with fire-and-forget pattern. LOST jobs are hidden from all selection dropdowns but remain visible in the admin job list. Backend capability gating prevents production, delivery, and claims actions for jobs not yet in the CONTRACTED phase. Key files: `shared/job-phases.ts`, `server/services/job-audit.service.ts`, `server/routes/middleware/job-capability.middleware.ts`.
- **AI Integration:** OpenAI is used for PDF analysis to extract panel specifications and AI-powered visual comparison summaries for documents.
- **Financial & Logistics:** Configurable rates and cost analysis, production tracking, and a logistics system for load list creation and delivery recording.
- **Scheduling:** Drafting and procurement scheduling linked to production slots, considering multi-factory support and CFMEU calendars.
- **Communication:** A Teams-style chat system with direct messages, groups, channels, @mentions, notifications, and file attachments.
- **Sales & Document Management:** A mobile-first pre-sales opportunity management system with a detailed sales pipeline, and a comprehensive document management system with version control, bundles, and entity linking.
- **Mobile Functionality:** Dedicated QR scanner for panels and document bundles, and mobile panel checklists (e.g., Pre-Pour, Post-Pour Quality Inspections) with conditional fields and system-locked templates.
- **Advanced Features:** Panel consolidation (merging multiple panels), contract retention tracking with automated deductions and caps, and visual document comparison with pixel-level overlay and AI summarization.
- **Asset Register:** Comprehensive asset lifecycle management with 50+ fields across 8 tabs (Basic Info, Photos, Financial, Technical, Insurance, Maintenance Records, Transfer History, AI Summary). Supports 40+ asset categories, auto-generated asset tags (AST-YYMM-NNNN), depreciation tracking, lease/finance management, insurance tracking, maintenance scheduling, transfer history, and AI-powered asset analysis via OpenAI. Database tables: `assets`, `asset_maintenance_records`, `asset_transfers`. Admin-only access with company isolation.

## Security: CSRF Protection Rules
This project has CSRF (Cross-Site Request Forgery) protection enabled globally. All new features MUST follow these rules:

**How it works:**
- A CSRF token is stored in a browser cookie (`csrf_token`) and automatically generated by `server/middleware/csrf.ts` via `csrfTokenGenerator`.
- The `csrfProtection` middleware validates that every mutating request (POST, PUT, PATCH, DELETE) includes a matching `x-csrf-token` header.
- Safe methods (GET, HEAD, OPTIONS) are exempt. Login/register paths are also exempt.

**Frontend rules for all new features:**
1. **Always use `apiRequest()` from `@/lib/queryClient`** for all API calls (POST, PUT, PATCH, DELETE). It automatically reads the CSRF cookie and attaches the `x-csrf-token` header. Never use raw `fetch()` for mutating requests.
2. **Always use `apiUpload()` from `@/lib/queryClient`** for file uploads via FormData. It also attaches the CSRF token automatically.
3. **Never use raw `fetch()` or `XMLHttpRequest` for mutating API calls** — they will fail with 403 "CSRF token missing".
4. **GET requests** can use the default TanStack Query `queryFn` (which uses raw fetch) since CSRF is not required for safe methods.

**Backend rules for all new features:**
1. **All new routes are automatically protected** by the global `csrfProtection` middleware registered in `server/routes/index.ts`. No per-route CSRF setup is needed.
2. **If a route must be exempt** (e.g., webhooks from external services), add its path to the `EXEMPT_PATHS` set in `server/middleware/csrf.ts`.
3. **Never disable or bypass CSRF** protection for authenticated user-facing endpoints.

**Key files:**
- `server/middleware/csrf.ts` — Token generation and validation middleware
- `client/src/lib/queryClient.ts` — `getCsrfToken()`, `apiRequest()`, `apiUpload()` with automatic CSRF header injection
- `server/routes/index.ts` — Global middleware registration (csrf is applied before all routes)

## External Dependencies
- **PostgreSQL**: Primary relational database.
- **OpenAI**: AI services for PDF analysis and visual comparison summaries.
- **React**: Frontend JavaScript library.
- **Vite**: Frontend build tool.
- **TanStack Query**: Data fetching and state management for React.
- **Wouter**: Lightweight routing library for React.
- **shadcn/ui**: Reusable UI components.
- **Tailwind CSS**: Utility-first CSS framework.
- **Express.js**: Backend web application framework.
- **Drizzle ORM**: TypeScript ORM for PostgreSQL.
- **bcrypt**: Library for hashing passwords.
- **express-session**: Middleware for session management.
- **connect-pg-simple**: PostgreSQL-backed session store for `express-session`.